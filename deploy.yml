# Configure loclahost Operator and Spawn Master Node
- name: Configure the Master
  hosts: localhost
  tags: Netm4ul
  vars_files:
    - config.cfg

  pre_tasks:
    - block:
      - name: Local pre-tasks
        include_tasks: playbooks/local.yml
        tags: [ 'always' ]

      - name: Local pre-tasks
        include_tasks: playbooks/local_ssh.yml
        become: false
        when: Deployed_By_Netm4ul is defined and Deployed_By_Netm4ul == "Y"
        tags: [ 'local' ]
      rescue:
        - debug: var=fail_hint
          tags: always
        - fail:
          tags: always

  roles:
    - { role: scaleway, tags: ['scaleway'] }

  post_tasks:
    - block:
      - name: Local post-tasks
        include_tasks: playbooks/post.yml
        become: false
        tags: [ 'cloud' ]

      - name : Install netmaul on post task
        include_tasks : playbooks/nodes.yml
        become: false




      rescue:
        - debug: var=fail_hint
          tags: always
        - fail:
          tags: always

# Install needed on
- name: Configure the server and install required software
  hosts: master
  gather_facts: false
  tags: Netm4ul
  become: true
  vars_files:
    - config.cfg

  pre_tasks:
    - block:
      - name: Common pre-tasks
        include_tasks: playbooks/common.yml
        tags: [ 'scaleway' ]
      rescue:
        - debug: var=fail_hint
          tags: always
        - fail:
          tags: always

  post_tasks:
    - block:
      - debug:
          msg:
            - "{{ congrats.common.split('\n') }}"
            - "    {% if cloud_deployment is defined %}{{ congrats.ssh_access }}{% endif %}"
        tags: always

      rescue:
        - debug: var=fail_hint
          tags: always
        - fail:
          tags: always